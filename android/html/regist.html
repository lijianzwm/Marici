<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>用户注册</title>
    <link rel="stylesheet" type="text/css" href="../css/login.css"/>
</head>
<body>
<header class="title" id="title">用户注册</header>
<div class="userinfo-wrapper">
    <div class="userinfo-line">
        <input type="text" class="phone" id="username" placeholder="请输入用户名"/>
    </div>
    <div class="userinfo-line">
        <input type="password" id="password" placeholder="请输入密码"/>
    </div>
    <div class="userinfo-line">
        <input type="password" id="confirm_password" placeholder="确认密码"/>
    </div>

    <div id="regist_button" class="button" >注册</div>
    <div id="back" class="button" >返回</div>

</div>

<script src="../script/zepto.min.js"></script>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/config.js"></script>
<script type="text/javascript">

    var code = 10000;
    var jsSendMessageWait = 60;
    var isEnableClick = true;

    domSendCodeButton = $('#send_code');

    apiready = function(){
        $api.fixStatusBar( $api.dom('header') );
        eventHandler();
    };

    function eventHandler(){

        $('#regist_button').click(function(){
            username = $('#username').val();
            password = $("#password").val();
            confirmPassword = $('#confirm_password').val();

            var patrn= /^[\u4E00-\u9FA5A-Za-z0-9_]+$/;
            if( username.length > 10 ){
                api.toast({
                    msg: "用户名过长!",
                    duration: 2000,
                    location: 'bottom'
                });
                return;
            }
            if( username.length < 2 ){
                api.toast({
                    msg: "用户名过短!",
                    duration: 2000,
                    location: 'bottom'
                });
                return;
            }
            if(!patrn.exec(username)){
                api.toast({
                    msg: "用户名只能以中文,大小写字母和数字组成",
                    duration: 2000,
                    location: 'bottom'
                });
                return;
            }

            var passwordPatrn = /^(\w){6,20}$/;
            if (!passwordPatrn.exec(password)){
                api.toast({
                    msg: "密码须由6-20个字母、数字、下划线组成",
                    duration: 2000,
                    location: 'bottom'
                });
                return;
            }

            if( password != confirmPassword ){
                api.toast({
                    msg: "两次密码不一致",
                    duration: 2000,
                    location: 'bottom'
                });
                return;
            }
            regist(username,password);
        });

        $('#back').click(function(){
            api.closeWin();
        })
    }

    function refreshCode(){
        code = Math.round(Math.random()*9000)+1000;
    }

    function isPhonelegal(){
        phone = $('#phone').val();
        phone = $.trim(phone);
        return (!isNaN(phone) && phone.length==11);
    }

    function time(obj){
        if( jsSendMessageWait == 0 ){
            obj.html("发送");
            isEnableClick = true;
        }else{
            isEnableClick = false;
            jsSendMessageWait -= 1;
            obj.html(jsSendMessageWait);
            setTimeout(function(){
                time(obj);
            },1000);
        }
    }

    function regist(username,password){
        api.ajax({
            url : apiHost+'/Api/User/regist',
            method : 'post',
            dataType:'json',
            data : {
                values : {
                    apikey : apiKey,
                    password : password,
                    username :username
                }
            }
        }, function(ret, err){
            if( ret ){
                if( ret.error_code ){
                    api.toast({
                        msg: ret.msg,
                        duration: 2000,
                        location: 'bottom'
                    });
                }else{
                    alert(ret.msg);
                    api.closeWin();
                }
            }else{
                alert(JSON.stringify(err))
            }
        });
    }

</script>
</body>
</html>