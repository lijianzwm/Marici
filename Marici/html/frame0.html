<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>计数</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../css/style.css"/>
    <style>

        .wrapper input{
            width:100%;
            height: 50px;
            border-top:1px solid;
            border-color:#E1E1E1;
            display:block;
        }

        .counter-button{
            font-size:80px;
            display:block;
            width:100%;
        }

    </style>
</head>
<body>
<input type="button" id="counter_button" class="counter-button" onclick="addOne()"/>
<div class="wrapper">
    <input type="button" id="sync_button" class="sync-button" value="同步到服务器" onclick="sync()"/>
    <input type="button" id="reset_button" class="reset-button" value="清零" onclick="setZeroQuery()"/>
    <input type="button" id="lock_screen" class="lock-screen" value="锁定屏幕" onclick="lockScreen()"/>
</div>

</body>
<script src="../script/zepto.min.js"></script>
<script src="../script/config.js"></script>
<script type="text/javascript">

    var lock = false;

    domCounterButton = $("#counter_button");
    apiready = function () {
        initCountButton();
        setInterval(function () {
            refreshCountButton();
        }, 200);


    };

    function refreshCountButton(){
        api.getPrefs({
            key: 'counter_num'
        }, function( ret, err ){
            if( ret ){
                num = parseInt(ret.value);
                domCounterButton.val(num);
            }else{
                num = parseInt(0);
                domCounterButton.val(num);
            }
        });
    }

    function addOne(){
        api.getPrefs({
            key: 'counter_num'
        }, function( ret, err ){
            if( ret ){
                num = parseInt(ret.value)+1;
                api.setPrefs({
                    key: 'counter_num',
                    value: num
                });
                domCounterButton.val(num);
            }else{
                num = parseInt(0);
                api.setPrefs({
                    key: 'counter_num',
                    value: num
                });
                domCounterButton.val(num);
            }
        });
    }

    function lockScreen(){
        api.openWin({
            name: 'lockScreen',
            url: './lockScreen.html',
            bounces: false,
            vScrollBarEnabled: false,
            hScrollBarEnabled: false
        });
    }

    function sync(){
        api.getPrefs({
            key: 'user'
        }, function( ret, err ){
            if( ret ){
                user = $.parseJSON(ret.value);
                pushNum(user.id, domCounterButton.val());
            }else{
                alert(JSON.stringify(err))
            }
        });
    }

    function pushNum(userid, num){
        api.ajax({
            url : apiHost+'/Api/Countin/addNum',
            method : 'post',
            dataType:'json',
            data : {
                values : {
                    apikey : apiKey,
                    userid : userid,
                    num : num
                }
            }
        }, function(ret, err){
            if( ret ){
                if( ret.error_code ){
                    alert(ret.msg);
                }else{
                    setZero();
                    alert("保存成功，本地计数自动清零");
                }
            }else{
                alert(JSON.stringify(err))
            }
        });
    }

    function setZeroQuery(){
        api.confirm({
            title: '清零',
            msg: '确定要清零吗？',
            buttons: ['确定', '取消']
        },function( ret, err ){
            if( ret ){
                if( ret.buttonIndex == 1){
                    setZero();
                }
            }else{
                alert( JSON.stringify( err ) );
            }
        });
    }

    function setZero(){
        api.setPrefs({
            key: 'counter_num',
            value: 0
        });
    }

    function initCountButton(){
        var frameHeight = api.frameHeight - 50*3 ;
        domCounterButton.css("height",frameHeight+"px");
    }

</script>
</html>